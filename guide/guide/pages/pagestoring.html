<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>25.1 Page storing 6.x</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/howToSource.html"><strong>2</strong><span>How to use the example code</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/whyLearn.html"><strong>3</strong><span>Why should I learn Wicket?</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/helloWorld.html"><strong>4</strong><span>Wicket says &ldquo;Hello world!&rdquo;</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/layout.html"><strong>5</strong><span>Wicket as page layout manager</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/keepControl.html"><strong>6</strong><span>Keeping control over HTML</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/componentLifecycle.html"><strong>7</strong><span>Components lifecycle</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/versioningCaching.html"><strong>8</strong><span>Page versioning and caching</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/requestProcessing.html"><strong>9</strong><span>Under the hood of the request processing</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/urls.html"><strong>10</strong><span>Wicket Links and URL generation</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/modelsforms.html"><strong>11</strong><span>Wicket models and forms</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/forms2.html"><strong>12</strong><span>Wicket forms in detail</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/repeaters.html"><strong>13</strong><span>Displaying multiple items with repeaters</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/i18n.html"><strong>14</strong><span>Internationalization with Wicket</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/resources.html"><strong>15</strong><span>Resource management with Wicket</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/jsintegration.html"><strong>16</strong><span>An example of integration with JavaScript</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/advanced.html"><strong>17</strong><span>Wicket advanced topics</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/ajax.html"><strong>18</strong><span>Working with AJAX</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/jee.html"><strong>19</strong><span>Integration with enterprise containers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/nativewebsockets.html"><strong>20</strong><span>Native WebSockets</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/security.html"><strong>21</strong><span>Security with Wicket</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/testing.html"><strong>22</strong><span>Test Driven Development with Wicket</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/testingspring.html"><strong>23</strong><span>Test Driven Development with Wicket and Spring</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/bestpractices.html"><strong>24</strong><span>Wicket Best Practices</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/internals.html"><strong>25</strong><span>Wicket Internals</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/maven.html"><strong>26</strong><span>Working with Maven (Appendix)</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/wicketstuff.html"><strong>27</strong><span>Project WicketStuff (Appendix)</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/redirects.html"><strong>28</strong><span>Lost In Redirection With Apache Wicket (Appendix)</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/contributing.html"><strong>29</strong><span>Contributing to this guide (Appendix)</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        <span id="logo"><a href="/" target="_blank"><img height="80px" src="http://wicket.apache.org/guide/img/apache-wicket.png"/></a></span>
        
        
        <span id="sponsor"><a href="http://www.apache.org/" target="_blank"><img height="60px" src="http://wicket.apache.org/guide/img/asf_logo.gif"/></a></span>
        
    </div>
    <p>Free Online Guide for Apache Wicket framework</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/bestpractices.html">&lt;&lt; <strong>24</strong><span>Wicket Best Practices</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/maven.html"><strong>26</strong><span>Working with Maven (Appendix)</span> >></a></div>
                


                <div class="project">
                    <h1>25.1 Page storing - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Andrea Del Bene, Martin Grigorov, Carsten Hufe, Christian Kroemer, Daniel Bartl, Paul Borș</p>

                    <p><strong>Version:</strong> 6.x</p>

                    
                </div>

                

                

<h2 id="pagestoring">25.1 Page storing</h2>
During request handling, Wicket manages page instances through interface <code>org.apache.wicket.request.handler.IPageProvider</code>. This interface creates a new page instance or loads a previously serialized page instance if we provide the corrisponding page id. <code>IPageProvider</code> delegates page creation and retrieval to interface <code>org.apache.wicket.request.mapper.IPageSource</code>.
When page class is provided <code>IPageSource</code> delegates page creation to interface <code>org.apache.wicket.IPageFactory</code>, while when page id is provided it uses interface <code>org.apache.wicket.page.IPageManager</code> to load the previously serialized page.<p class="paragraph"/>The following workflow diagram summarizes the mechanism seen so far:<p class="paragraph"/><img border="0" class="center" src="../img/page-storage.png"></img><p class="paragraph"/><h3>IPageManager</h3><p class="paragraph"/><code>org.apache.wicket.page.IPageManager</code>'s task is to manage which pages have been used in a request and store their last state in the backing stores, namely <code>IPageStore</code>.
The default implementation <code>org.apache.wicket.page.PageStoreManager</code> collects all stateful pages which have been used in the request cycle (more than one page can be used in a single request if for example <code>setResponsePage()</code> or <code>RestartResponseException</code> is used).
At the end of the request all collected page instances are being stored in the first level cache - http session. They are stored in http session attribute named <code>"wicket:persistentPageManagerData-APPLICATION_NAME"</code> and passed to the underlying <code>IPageStore</code>.
When the next http request comes <code>IPageProvider</code> will ask for page with specific id and <code>PageStoreManager</code> will look first in the http session and if no match is found then it will delegate to the IPageStore. At the end of the second request the http session based cache is being overwritten completely with the newly used page instances.<p class="paragraph"/>To setup another <code>IPageManager</code> implementation use <code>org.apache.wicket.Application.setPageManagerProvider(IPageManagerProvider)</code>.
The custom <code>IPageManager</code> implementation may or may not use <code>IPageStore/IDataStore</code>.<p class="paragraph"/><h3>IPageStore</h3><p class="paragraph"/><code>org.apache.wicket.pageStore.IPageStore</code>'s role is to mediate the storing and loading of pages done by the underlying <code>IDataStore</code>. The default implementation <code>org.apache.wicket.pageStore.DefaultPageStore</code> pre-processes the pages before passing them to <code>IDataStore#storeData(String, int, byte)</code> and to post-processes them after <code>IDataStore#getData(String, int)</code>. The processing consists of transforming the page instance to <code>org.apache.wicket.pageStore.DefaultPageStore.SerializedPage</code>. This is a struct of:<p class="paragraph"/><div class="code"><pre>&#123;
   sessionId: <span class="java&#45;object">String</span>,
   pageId : <span class="java&#45;object">int</span>,
   data : <span class="java&#45;object">byte</span>&#91;&#93;
&#125;</pre></div><p class="paragraph"/>i.e. this is the serialized page instance (data) plus additional information needed to be able to easily find it later (sessionId, pageId).<p class="paragraph"/>When a <code>SerializedPage</code> has to be stored <code>DefaultPageStore</code> stores it in a application scoped cache ({sessionId, pageId} -&#62; SerializedPage) and additionally gives it to the underlying <code>IDataStore#storeData(sessionId, pageId, data)</code>. The application scoped cache is used as second level cache. Getting a page from it is slower than the http session based cache in <code>PageStoreManager</code> because the page has to be deserialized, but is faster than the underlying <code>IDataStore</code> which stores the page bytes in some persistent store.<p class="paragraph"/>The size of the application scoped cache is configurable via <code>org.apache.wicket.settings.IStoreSettings.setInmemoryCacheSize(int)</code>.<p class="paragraph"/><h3>IDataStore</h3><p class="paragraph"/><code>org.apache.wicket.pageStore.IDataStore</code> is used to persist Wicket pages (as bytes) to a persistent store like e.g. files or databases. The default implementation is <code>org.apache.wicket.pageStore.DiskDataStore</code> which as its name says stores the pages in files. The location of the folder where the files are stored is configurable via <code>org.apache.wicket.settings.IStoreSettings.setFileStoreFolder(File)</code>, by default the web container's work folder is used (ServletContext attribute 'javax.servlet.context.tempdir'). In this folder a sub-folder is created named <code>'applicationName-filestore'</code>. 
This folder contains a sub-folder for each active http session. This session folder contains a single file named 'data' which contains the bytes for the pages. The size of this 'data' file is configurable via <code>org.apache.wicket.settings.IStoreSettings.setMaxSizePerSession(Bytes)</code>. When this size is exceeded the newly stored files overwrite the oldest ones.<p class="paragraph"/><h3>AsynchronousDataStore</h3><p class="paragraph"/>By default Wicket wraps <code>DiskDataStore</code> with <code>org.apache.wicket.pageStore.AsynchronousDataStore</code>. The role of <code>AsynchronousDataStore</code> is to detach the http worker thread from waiting for the write of the page bytes to the disk.
To disable it use: <code>org.apache.wicket.settings.IStoreSettings.setAsynchronous(false)</code>. AsynchronousDataStore can delay the storage of pages' bytes for at most <code>org.apache.wicket.settings.IStoreSettings.setAsynchronousQueueCapacity(int)</code> pages. If this capacity is exceeded then the page's bytes are written synchronously to the backing <code>IDataStore</code>.<p class="paragraph"/><h3>DebugDiskDataStore</h3><p class="paragraph"/>Wicket provides an extension of <code>DiskDataStore</code> that can be used to browse the content of the 'data' files created by <code>DiskDataStore</code>. This debug enabled <code>DiskDataStore</code> is automatically setup when wicket-devutils.jar is in the classpath.
The debug information can be seen at http://host:port/context/wicket/internal/debug/diskDataStore<p class="paragraph"/><h3>HttpSessionDataStore</h3><p class="paragraph"/>In some environments like Google AppEngine it is not allowed to write to the file system and thus <code>DiskDataStore</code> cannot be used. In this case <code>org.apache.wicket.pageStore.memory.HttpSessionDataStore</code> can be used as replacement. This implementation of <code>IDataStore</code> is not persistent and puts all the data in the http session.
Wicket comes with 2 default eviction strategies to keep the size of the http session reasonable:
<ul class="star">
<li><strong class="bold">org.apache.wicket.pageStore.memory.PageNumberEvictionStrategy</strong> - specifies how many pages can be hold</li>
<li><strong class="bold">org.apache.wicket.pageStore.memory.MemorySizeEvictionStrategy</strong> - specifies the maximum amount of memory for pages per http session.</li>
</ul><p class="paragraph"/>To configure it:
<div class="code"><pre>MyApp&#35;init()
&#123;
   <span class="java&#45;keyword">super</span>.init();<p class="paragraph"/>   setPageManagerProvider(<span class="java&#45;keyword">new</span> DefaultPageManagerProvider()
   &#123;
       <span class="java&#45;keyword">protected</span> IDataStore newDataStore()
       &#123;
           <span class="java&#45;keyword">return</span>  <span class="java&#45;keyword">new</span> HttpSessionDataStore(pageManagerContext, <span class="java&#45;keyword">new</span> PageNumberEvictionStrategy(20));
       &#125;
   &#125;
&#125;</pre></div><p class="paragraph"/>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/bestpractices.html">&lt;&lt; <strong>24</strong><span>Wicket Best Practices</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/maven.html"><strong>26</strong><span>Working with Maven (Appendix)</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
Copyright &copy; 2013-2014 — <a href="http://www.apache.org/" target="_blank">The Apache Software Foundation</a> 
                      — <b style="color:#E8590A !important;">(Generated on: 2014-11-11)</b>

    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
