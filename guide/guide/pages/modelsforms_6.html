<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>11.6 Detachable models 6.x</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/howToSource.html"><strong>2</strong><span>How to use the example code</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/whyLearn.html"><strong>3</strong><span>Why should I learn Wicket?</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/helloWorld.html"><strong>4</strong><span>Wicket says &ldquo;Hello world!&rdquo;</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/layout.html"><strong>5</strong><span>Wicket as page layout manager</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/keepControl.html"><strong>6</strong><span>Keeping control over HTML</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/componentLifecycle.html"><strong>7</strong><span>Components lifecycle</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/versioningCaching.html"><strong>8</strong><span>Page versioning and caching</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/requestProcessing.html"><strong>9</strong><span>Under the hood of the request processing</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/urls.html"><strong>10</strong><span>Wicket Links and URL generation</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/modelsforms.html"><strong>11</strong><span>Wicket models and forms</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/forms2.html"><strong>12</strong><span>Wicket forms in detail</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/repeaters.html"><strong>13</strong><span>Displaying multiple items with repeaters</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/i18n.html"><strong>14</strong><span>Internationalization with Wicket</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/resources.html"><strong>15</strong><span>Resource management with Wicket</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/jsintegration.html"><strong>16</strong><span>An example of integration with JavaScript</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/advanced.html"><strong>17</strong><span>Wicket advanced topics</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/ajax.html"><strong>18</strong><span>Working with AJAX</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/jee.html"><strong>19</strong><span>Integration with enterprise containers</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/nativewebsockets.html"><strong>20</strong><span>Native WebSockets</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/security.html"><strong>21</strong><span>Security with Wicket</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/testing.html"><strong>22</strong><span>Test Driven Development with Wicket</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/testingspring.html"><strong>23</strong><span>Test Driven Development with Wicket and Spring</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/bestpractices.html"><strong>24</strong><span>Wicket Best Practices</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/internals.html"><strong>25</strong><span>Wicket Internals</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/maven.html"><strong>26</strong><span>Working with Maven (Appendix)</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/wicketstuff.html"><strong>27</strong><span>Project WicketStuff (Appendix)</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/redirects.html"><strong>28</strong><span>Lost In Redirection With Apache Wicket (Appendix)</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/contributing.html"><strong>29</strong><span>Contributing to this guide (Appendix)</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        <span id="logo"><a href="/" target="_blank"><img height="80px" src="http://wicket.apache.org/guide/img/apache-wicket.png"/></a></span>
        
        
        <span id="sponsor"><a href="http://www.apache.org/" target="_blank"><img height="60px" src="http://wicket.apache.org/guide/img/asf_logo.gif"/></a></span>
        
    </div>
    <p>Free Online Guide for Apache Wicket framework</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/urls.html">&lt;&lt; <strong>10</strong><span>Wicket Links and URL generation</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/forms2.html"><strong>12</strong><span>Wicket forms in detail</span> >></a></div>
                


                <div class="project">
                    <h1>11.6 Detachable models - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Andrea Del Bene, Martin Grigorov, Carsten Hufe, Christian Kroemer, Daniel Bartl, Paul Bor»ô</p>

                    <p><strong>Version:</strong> 6.x</p>

                    
                </div>

                

                

<h2 id="modelsforms_6">11.6 Detachable models</h2>
<p class="paragraph"/>In chapter 6 we have seen how Wicket uses serialization to store page instances. When an object is serialized, all its referenced objects are recursively serialized. For a page this means that all its children components, their related models as well as the model objects inside them will be serialized. 
For model objects this could be a serious issue for (at least) two main reasons:
<ol>
<li>The model object could be a very large instance, hence serialization would become very expensive in terms of time and memory.</li>
<li>We simply may not be able to use a serializable object as model object. In paragraphs 1.4 and 9.2 we stated that Wicket allows us to use a POJO as backing object, but <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object#Definition" target="blank">POJOs</a> are ordinary objects with no prespecified interface, annotation or superclass, hence they are not required to implement the standard Serializable interface.</li>
</ol><p class="paragraph"/>To cope with these problems IModel extends another interface called IDetachable.<p class="paragraph"/><img border="0" class="center" src="../img/detachable-models.png"></img><p class="paragraph"/>This interface provides a method called detach() which is invoked by Wicket at the end of web request processing when data model is no more needed but before serialization occurs. Overriding this method we can clean any reference to data object keeping just the information needed to retrieve it later (for example the id of the table row where our data are stored). In this way we can avoid the serialization of the object wrapped into the model overcoming both the problem with non-serializable objects and the one with large data objects.<p class="paragraph"/>Since IModel inherits from IDetachable, every model of Wicket is ‚Äúdetachable‚Äù, although not all of them implement a detaching policy (like the Model class). 
Usually detaching operations are strictly dependent on the persistence technology adopted for model objects (like a relational db, a NoSQL db, a queue, etc), so it's not unusual to write a custom detachable model suited for the persistence technology chosen for a given project. To ease this task Wicket provides abstract model LoadableDetachableModel. This class internally holds a transient reference to a model object which is initialized the first time getObject()is called to precess a request. The concrete data loading is delegated to abstract method T load(). The reference to a model object is automatically set to null at the end of the request by the detach() method.<p class="paragraph"/>The following class diagram summarizes the methods defined inside LoadableDetachableModel.<p class="paragraph"/><img border="0" class="center" src="../img/loadable-detachable-model.png"></img><p class="paragraph"/>onDetach and onAttach can be overridden in order to obtain further control over the detaching procedure.<p class="paragraph"/>Now as example of a possible use of LoadableDetachableModel, we will build a model designed to work with entities managed via <a href="http://en.wikipedia.org/wiki/Java_Persistence_API" target="blank">JPA.</a> To understand the following code a basic knowledge of JPA is required even if we won't go into the detail of this standard.<p class="paragraph"/><blockquote class="warning">
The following model is provided for example purposes only and is not intended to be used in production environment. Important aspects such as transaction management are not taken into account and you should rework the code before considering to use it.
</blockquote><p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">public</span> class JpaLoadableModel&#60;T&#62; <span class="java&#45;keyword">extends</span> LoadableDetachableModel&#60;T&#62; &#123;<p class="paragraph"/>  <span class="java&#45;keyword">private</span> EntityManagerFactory entityManagerFactory;
  <span class="java&#45;keyword">private</span> <span class="java&#45;object">Class</span>&#60;T&#62; entityClass;
  <span class="java&#45;keyword">private</span> Serializable identifier;
  <span class="java&#45;keyword">private</span> List&#60;<span class="java&#45;object">Object</span>&#62; constructorParams;<p class="paragraph"/>  <span class="java&#45;keyword">public</span> JpaLoadableModel(EntityManagerFactory entityManagerFactory, T entity) &#123;<p class="paragraph"/>	<span class="java&#45;keyword">super</span>();<p class="paragraph"/>	PersistenceUnitUtil util = entityManagerFactory.getPersistenceUnitUtil();<p class="paragraph"/>		<span class="java&#45;keyword">this</span>.entityManagerFactory = entityManagerFactory;
	    <span class="java&#45;keyword">this</span>.entityClass = (<span class="java&#45;object">Class</span>&#60;T&#62;) entity.getClass();
	    <span class="java&#45;keyword">this</span>.identifier = (Serializable) util.getIdentifier(entity);<p class="paragraph"/>	    setObject(entity);
	&#125;<p class="paragraph"/>	@Override
	<span class="java&#45;keyword">protected</span> T load() &#123;
	   T entity = <span class="java&#45;keyword">null</span>;<p class="paragraph"/>	   <span class="java&#45;keyword">if</span>(identifier != <span class="java&#45;keyword">null</span>) &#123;  
	       EntityManager entityManager = entityManagerFactory.createEntityManager();
	       entity = entityManager.find(entityClass, identifier);
	     &#125;
	     <span class="java&#45;keyword">return</span> entity;
	   &#125;<p class="paragraph"/>	@Override
	<span class="java&#45;keyword">protected</span> void onDetach() &#123;
	   <span class="java&#45;keyword">super</span>.onDetach();<p class="paragraph"/>	     T entity = getObject();
	     PersistenceUnitUtil persistenceUtil = entityManagerFactory.getPersistenceUnitUtil();<p class="paragraph"/>	     <span class="java&#45;keyword">if</span>(entity == <span class="java&#45;keyword">null</span>) <span class="java&#45;keyword">return</span>;<p class="paragraph"/>	     identifier = (Serializable) persistenceUtil.getIdentifier(entity);    
	  &#125;
	&#125;</pre></div><p class="paragraph"/>The constructor of the model takes as input two parameters: an implementation of the JPA interface  javax.persistence.EntityManagerFactory to manage JPA entities and the entity that must be handled by this model. Inside its constructor the model saves the class of the entity and its id (which could be null if the entity has not been persisted yet). These two informations are required to retrieve the entity at a later time and are used by the load method.<p class="paragraph"/>onDetach is responsible for updating the entity id before detachment occurs. The id can change the first time an entity is persisted (JPA generates a new id and assigns it to the entity). Please note that this model is not responsible for saving any changes occurred to the entity object before it is detached. If we don't want to loose these changes we must explicitly persist the entity before the detaching phase occurs.<p class="paragraph"/><blockquote class="warning">
Since the model of this example holds a reference to the EntityManager Factory, the implementation in use must be serializable.
</blockquote>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/urls.html">&lt;&lt; <strong>10</strong><span>Wicket Links and URL generation</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/forms2.html"><strong>12</strong><span>Wicket forms in detail</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
Copyright &copy; 2013-2014 ‚Äî <a href="http://www.apache.org/" target="_blank">The Apache Software Foundation</a> 
                      ‚Äî <b style="color:#E8590A !important;">(Generated on: 2015-02-03)</b>

    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
